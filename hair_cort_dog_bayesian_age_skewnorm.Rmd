---
title: "hair_cortisol_dog_combined"
author: "Alex German"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Check working directory
```{r}
getwd()
```





# Load packages
```{r}
library(readxl)
library(psych)
library(dlookr)
library(vtable)
library(dplyr)
library(reshape)
library(ggplot2)

library(brms)
library(rethinking)
library(loo)
library(priorsense)
library(tidyverse)
library(vioplot)
library(bayesplot)
library(bayestestR)
```


# Load data
```{r}
df <- read_xlsx("hair_cort_dog_all.xlsx", col_types = c("text", "text",  
                               "text", "text", "text", "text",
                               "text", "numeric","text", "skip",
                               "numeric", "skip", "skip", 
                               "numeric", "skip"))
df <- as.data.frame(df)
```



# INITIAL DATA PLOTTING AND EXPLORATION

## Check characteristics of df
```{r}
dim(df) # will tell you how many rows and columns the dataset has
class(df) # will tell you what data structure has the dataset been assigned
```


## Explore the dataset to understand its structure.
```{r}
head(df)
```


# 1.  Get summary stats for numeric data ####
## a. all data
```{r}
numeric_df <- Filter(is.numeric, df)
describe(numeric_df) # the describe function in psych provides summary stats
```


## b. completed v0
```{r}
df_compv0 <- df[ df$group == "completed" , ] 
df_compv0 <- df_compv0[ df_compv0$visit == "v0" , ]
sumtable(df_compv0, digits = 5, add.median = TRUE)
```


## b. completed v1
```{r}
df_compv1 <- df[ df$group == "completed" , ] 
df_compv1 <- df_compv1[ df_compv1$visit == "v1" , ]
sumtable(df_compv1, digits = 5, add.median = TRUE)
```


## b. stopped
```{r}
df_stop <- df[ df$group == "stopped" , ] 
sumtable(df_stop, digits = 5, add.median = TRUE)
```




# 2. Check normality of all numeric variables
## a. graphical assessment
```{r}
plot_normality(numeric_df)
```


## b. shapiro-wilk test
```{r}
apply(numeric_df, 2, shapiro.test)
```


## c. repeat Q-Q plots with transformed data
### i. log(cortisol)
```{r}
qqnorm(df$cortisol)
qqline(df$cortisol, col = "red")
qqnorm(log(df$cortisol))
qqline(log(df$cortisol), col = "red")
```

### ii Shapiro test for log cortisol
```{r}
shapiro.test(log(df$cortisol))
```






# 3. Check data numerically
```{r}
summary(df$cortisol)
summary(log(df$cortisol))
```


## a. log-transform cortisol
```{r}
df$lgCort <- log(df$cortisol)
summary(df$lgCort)
```


### i. visualise
```{r}
hist(df$lgCort)
```



## b. Create simple category name for breed and convert to factor
```{r}
df$breed <- df$breed_group
df$breed <- factor(df$breed, levels = c("mix", "ckcs", "pug", "ret", "other"))
head(df$breed)
```



## c. Make light hair colour the reference category
```{r}
df$coat_colour <- factor(df$coat_colour, levels = c("light", "mix", "dark"), ordered = FALSE)
head(df$coat_colour)
```



# 4. Generate data summary
## all data
```{r}
sumtable(df)
```



# 5. Visualise associations
## a. Between Cortisol and sex with a violin plot (vioplot package)
```{r}
par(mfrow = c(1,1))
vioplot(cortisol ~ sex, col = "firebrick",
        data = df)
```


## b. Between lgCortisol and sex with a violin plot (vioplot package)
```{r}
par(mfrow = c(1,1))
vioplot(lgCort ~ sex, col = "lemonchiffon",
        data = df)
```


## c. Between lgCortisol and breed
### i. with a violin plot (vioplot package)
```{r}
par(mfrow = c(1,1))
vioplot(lgCort ~ breed, col = "firebrick",
        data = df)
```


### ii. with stripchart
```{r}
stripchart(lgCort ~ breed, vertical = TRUE, method = "jitter",
           col = "steelblue3", data = df, pch = 20)

```


## d. Between Cortisol and comorbidity with a violin plot (vioplot package)
```{r}
par(mfrow = c(1,1))
vioplot(cortisol ~ comorbidity, col = "steelblue",
        data = df)
```


## e. Between log(cortisol) and comorbidity with a violin plot (vioplot package)
```{r}
par(mfrow = c(1,1))
vioplot(lgCort ~ comorbidity, col = "steelblue",
        data = df)
```


## f. Between cortisol and age with a dotplot
```{r}
plot(cortisol ~ age, col = "steelblue3", data = df, pch = 20)
```


## g. Between log(cortisol) and age with a dotplot
```{r}
plot(lgCort ~ age, col = "steelblue3", data = df, pch = 20)
```


## h. Between cortisol and body fat with a dotplot
```{r}
plot(cortisol ~ fat_percent, col = "steelblue3", data = df, pch = 20)
```


## h. Between log(cortisol) and body fat with a dotplot
```{r}
plot(lgCort ~ fat_percent, col = "steelblue3", data = df, pch = 20)
corr.test(df$lgCort, df$fat_percent)
```





# STANDARDISE DATA FOR MODELLING

## 1. Standardise body fat
```{r}
df$sFat <- standardize(df$fat_percent)
summary(df$sFat)
```

### a. visualise standardised lgCort
```{r}
hist(df$sFat)
```



## 2. Standadrise Age
```{r}
df$sAge <- standardize(df$age)
summary(df$sAge)
```


## 3. Standardise lg(cortisol)
```{r}
df$slgCort <- standardize(df$lgC)
summary(df$slgCort)
```


### a. visualise standardised lgCort
```{r}
hist(df$slgCort)
```




## 2. create dataset only containing complete data
```{r}
df2 <- na.omit(df)
```




# MODEL FOR THE EFFECT OF sAGE ON HAIR CORTISOL

##  1. Model code
# model code
model <- brm(slgCort ~ sAge + breed + (1 | visit),
                   family = skew_normal(),
                   data = df2)



## 2. Check what priors need to be set
```{r}
default_prior(slgCort ~ sAge + breed + (1 | visit),
                   family = skew_normal(),
                   data = df2)
```



####  Published information about associations between hair cortisol and age

Not much evidence of an effect of age on hair cortisol in the literature.  However, no effect in one study
(Bowland GB.  Front. Vet. Sci 2020; 7:565346. doi: 10.3389/fvets.2020.565346)

No published data about effects on breed, but this is plausible (as effect of hair colour)
However, unclear as to which breeds will differ and which way.


Therefore, use regularising priors for all but keep it neutral and relatively broad.


## 3. Set priors
```{r}
# Set individual priors
prior_int <- set_prior("normal(0, 0.5)", class = "Intercept")
prior_sig <- set_prior("exponential(1)", class = "sigma")
prior_b <- set_prior("normal(0, 1)", class = "b")
prior_b_sAge <- set_prior("normal(0, 0.5)", class = "b", coef = "sAge")
prior_sd <- set_prior("normal(0, 1)", class = "sd")
prior_alpha <- set_prior("normal(4, 2)", class = "alpha")

# Combine priors into list
priors <- c(prior_int, prior_sig, prior_b, prior_b_sAge, prior_sd, prior_alpha)
```


## 4. Plot prior
### a. Prior for intercept
```{r}
x <- seq(-3, 3, length.out = 100)
y <- dnorm(x, mean = 0, sd = 0.5)
plot(y ~ x, type = "l")
```




### b. Prior for sigma
```{r}
x <- seq(0, 3, length.out = 100)
y <- dexp(x, rate = 1)
plot(y ~ x, type = "l")
```


### c. Prior for  beta of sAge
```{r}
x <- seq(-2, 2, length.out = 100)
y <- dnorm(x, mean = 0, sd = 0.5)
plot(y ~ x, type = "l")
```


## Prior for  beta of breed
```{r}
x <- seq(-2, 2, length.out = 100)
y <- dnorm(x, mean = 0, sd = 1)
plot(y ~ x, type = "l")
```





## 5.  Run model
Increased adapt_delta >0.8 (0.9 here), as had divergent transitions
```{r}
set.seed(666)
model <- brm(slgCort ~ sAge + breed + (1 | visit),
                   family = skew_normal(),
                   prior = priors,
                   data = df,
                  control=list(adapt_delta=0.99999, stepsize = 0.001, max_treedepth = 15),
                   iter = 8000, warmup = 2000,
                   save_pars = save_pars(all =TRUE),
                   sample_prior = TRUE)
```


## 6. Get summary of model
```{r}
summary(model)
```

## 7. MCMC diagnostics
### a. check for convergence
```{r}
plot(model)
```
Looking for hairy caterpillars



## b. try a trank plot as well
```{r}
mcmc_plot(model, type = 'rank_overlay')
```



# 8. Calculate 97% HPDI for age
Usually better than the compatoability intervals given in the summary
```{r}
draws <- as.matrix(model)
HPDI(draws[,2], 0.97) # 1st column is draws for age
```


# 9. Calculate R2 for model
```{r}
bayes_R2(model, probs = c(0.015, 0.5, 0.985)) # 0.015, 0.5, 0.985 are the quantiles
loo_R2(model, probs = c(0.015, 0.5, 0.985)) # 0.015, 0.5, 0.985 are the quantiles
```




# CHECKS ON MODEL

## 1. Basic check of simulations based on posterior distribution, versus the real data distribution
checks whether actual data is similar to simulated data.
```{r}
pp_check(model, ndraws = 100) 
```



## 2. Check some individual draws versus observed using pp_check
```{r}
par(mfrow = c(1,1))
pp_check(model, type = "hist", ndraws = 11, binwidth = 0.25) # separate histograms of 11 MCMC draws vs actual data
```



## 3. Other pp_check graphs
```{r}
pp_check(model, type = "error_hist", ndraws = 11) # separate histograms of errors for 11 draws
pp_check(model, type = "scatter_avg", ndraws = 100) # scatter plot
pp_check(model, type = "stat_2d") #  scatterplot of joint posteriors
# PPC functions for predictive checks based on (approximate) leave-one-out (LOO) cross-validation
pp_check(model, type = "loo_pit_overlay", ndraws = 1000) 
```


# 4. Error scatter average  plot (recommended by Buerkner)
```{r}
pp_check(model, type = "error_scatter_avg")
```



# 5. Pairs plot
```{r}
pairs(model)
```



# PSIS LOO-CV to check model performance
```{r}
loo_model <- loo(model, moment_match = TRUE)
loo_model
```




# AUTOMATED PRIOR SENSITIVITY USING THE PRIOR SENSE PACKAGE
  
## 1. Sensitivity check
First, check the sensitivity of the prior and likelihood to power-scaling. 
Posterior and posteriors resulting from power-scaling.
```{r}
powerscale_sensitivity(model, variable = c("b_Intercept", "sigma", "b_sAge", "b_breedckcs", "b_breedother", "b_breedpug", "b_breedret"), facet_rows = "variable")
```

## 2. Kernel density
```{r}
powerscale_plot_dens(model, variable = c("b_Intercept", "sigma", "b_sAge", "b_breedckcs", "b_breedother", "b_breedpug", "b_breedret"), facet_rows = "variable")
```


# 3. Empirical cumulative distribution functions
```{r}
powerscale_plot_ecdf(model, variable = c("b_Intercept", "sigma", "b_sAge", "b_breedckcs", "b_breedother", "b_breedpug", "b_breedret"), facet_rows = "variable")
```


# 4. Quantities
```{r}
powerscale_plot_quantities(model, variable = c("b_Intercept", "sigma", "b_sAge", "b_breedckcs", "b_breedother", "b_breedpug", "b_breedret"), facet_rows = "variable")
```


# 5.  Check mean and sd of mode to see if the issue can be identified
```{r}
mean(model$data$slgCort)
sd(model$data$slgCort)
```
These values appear similar to what was set for the priors, so seems OK?




## 6.  Now use bayestestR package to check priors are informative
```{r}
check_prior(model, effects = "all")
```



# CHECK PRIOR PREDICTION LINES FROM FINAL MODEL

# 1. Obtain draws of priors from final model
```{r}
prior <- prior_draws(model)
prior %>% glimpse()
```


# 2. Plot prior prediction lines for sAge
```{r}
set.seed(5)

prior %>% 
  slice_sample(n = 50) %>% 
  rownames_to_column("draw") %>% 
  expand_grid(a = c(-2, 2)) %>% 
  mutate(c = Intercept + b_sAge * a) %>% 
  
  ggplot(aes(x = a, y = c)) +
  geom_line(aes(group = draw),
            color = "firebrick", alpha = .4) +
  labs(x = "Age (std)",
       y = "log(cort) (std)") +
  coord_cartesian(ylim = c(-2, 2)) +
  theme_bw() +
  theme(panel.grid = element_blank()) 
```


## 3. Priors for breed CKCS with line plot
```{r}
set.seed(5)

prior %>% 
  slice_sample(n = 50) %>% 
  rownames_to_column("draw") %>% 
  expand_grid(a = c(0, 1)) %>% 
  mutate(c = Intercept + b_breedckcs * a) %>% 
  
  ggplot(aes(x = a, y = c)) +
  geom_line(aes(group = draw),
            color = "firebrick", alpha = .4) +
  geom_point(color = "firebrick", size = 2) +
  labs(x = "CKCS Breed",
       y = "log(cort) (std)") +
  coord_cartesian(ylim = c(-3, 3)) +
  theme_bw() +
  theme(panel.grid = element_blank()) 
```


## 4. Priors for breed pug with line plot
```{r}
set.seed(5)

prior %>% 
  slice_sample(n = 50) %>% 
  rownames_to_column("draw") %>% 
  expand_grid(a = c(0, 1)) %>% 
  mutate(c = Intercept + b_breedpug * a) %>% 
  
  ggplot(aes(x = a, y = c)) +
  geom_line(aes(group = draw),
            color = "firebrick", alpha = .4) +
  geom_point(color = "firebrick", size = 2) +
  labs(x = "Pug breed",
       y = "log(cort) (std)") +
  coord_cartesian(ylim = c(-3, 3)) +
  theme_bw() +
  theme(panel.grid = element_blank()) 
```



## 5. Priors for breed ret with line plot
```{r}
set.seed(5)

prior %>% 
  slice_sample(n = 50) %>% 
  rownames_to_column("draw") %>% 
  expand_grid(a = c(0, 1)) %>% 
  mutate(c = Intercept + b_breedret * a) %>% 
  
  ggplot(aes(x = a, y = c)) +
  geom_line(aes(group = draw),
            color = "firebrick", alpha = .4) +
  geom_point(color = "firebrick", size = 2) +
  labs(x = "Retriever breed",
       y = "log(cort) (std)") +
  coord_cartesian(ylim = c(-3, 3)) +
  theme_bw() +
  theme(panel.grid = element_blank()) 
```



## 6. Priors for breed other with line plot
```{r}
set.seed(5)

prior %>% 
  slice_sample(n = 50) %>% 
  rownames_to_column("draw") %>% 
  expand_grid(a = c(0, 1)) %>% 
  mutate(c = Intercept + b_breedother * a) %>% 
  
  ggplot(aes(x = a, y = c)) +
  geom_line(aes(group = draw),
            color = "firebrick", alpha = .4) +
  geom_point(color = "firebrick", size = 2) +
  labs(x = "Other Breed",
       y = "log(cort) (std)") +
  coord_cartesian(ylim = c(-3, 3)) +
  theme_bw() +
  theme(panel.grid = element_blank()) 
```





# CHECK PRIOR PREDICTIVE DISTRIBUTION

# 1. Prior Predictive Distribution
Can simulate data just on the priors.  Fit model but only consider prior when fitting model.
If this looks reasonable, it helps to confirm that your priors were reasonable
```{r}
set.seed(666)
model_priors_only <- brm(slgCort ~ sAge + breed + (1 | visit),
                   family = skew_normal(),
                   prior = priors,
                   data = df,
                   sample_prior = "only")
```


# 2. Check predictions against priors
```{r}
pp_check(model_priors_only, ndraws = 100)
```



# VARIANCE-COVARIANCE MATRIX

```{r}
as_draws_df(model) %>%
  select(b_Intercept:sigma) %>%
  cov() %>%
  round(digits = 3)
```





# MANUAL POSTERIOR PREDICITVE DISTRIBUTION CHECKS
NB Uses posterior_predict
## 1. Posterior predictive distribution plots for a continuous predictor variable
```{r}
par(mfrow = c(1,4))
# plot the observed data
plot(slgCort ~ sAge, main = "Observed", col = "steelblue",
     data = df, ylim = c(-3, 3)) # This is the observed data

# use posterior predict to simulate predictions
ppd <- posterior_predict(model) 
dim(ppd)

# Plot 3 simulations of the data
plot(ppd[50,] ~ df$sAge, main = "Simulated", 
     ylim = c(-3,3), col = "firebrick") 
plot(ppd[51,] ~ df$sAge, main = "Simulated", 
     ylim = c(-3,3), col = "firebrick") 
plot(ppd[52,] ~ df$sAge, main = "Simulated", 
     ylim = c(-3,3), col = "firebrick")
```



## 2. Posterior predictive distribition plots for a categorical predictor variable with small group size
```{r}
par(mfrow = c(2,2))
stripchart(slgCort ~ breed, vertical = TRUE, method = "jitter",
           col = "steelblue3", data = df, pch = 20, main = "Observed")
stripchart(ppd[sample(seq(1, dim(ppd)[1]), 1),] ~ breed, vertical = TRUE, method = "jitter",
           col = "firebrick", data = df, pch = 20, main = "PPD")
stripchart(ppd[sample(seq(1, dim(ppd)[1]), 1),] ~ breed, vertical = TRUE, method = "jitter",
           col = "firebrick", data = df, pch = 20, main = "PPD")
stripchart(ppd[sample(seq(1, dim(ppd)[1]), 1),] ~ breed, vertical = TRUE, method = "jitter",
           col = "firebrick", data = df, pch = 20, main = "PPD")
```




## ANALYSING THE POSTERIOR DISTRIBUTION

# 1. Plot conditional effects from model
```{r}
plot(conditional_effects(model), ask = FALSE)
```


### b. format and plot conditional effects for age
```{r}
ce <- conditional_effects(model, "sAge")
plot(ce, plot = FALSE)[[1]] +
         theme_bw() +
         labs(title = "Conditional effect of age on hair cortisol") +
         labs(y = paste0("Log hair cortisol (standardised)")) +
         labs(x = paste0("Age (standardised)")) +
         theme(axis.title.y = element_text(size=12, face="bold"), 
               axis.title.x = element_text(size=12, face="bold"),
               title = element_text(size=12, face="bold"),
               plot.title = element_text(hjust = 0.5),
               axis.text.x = element_text(color = "grey50", size = 12),
               axis.text.y = element_text(color = "grey50", size = 10),
               legend.position = "inside", legend.position.inside = c(0.93, 0.80))
```









# 2. mcmc_plot of model
## a.just parameters of beta variables
```{r}
mcmc_plot(model,
          variable = c(
         "b_sAge",
         "b_breedckcs",
         "b_breedpug",
         "b_breedret",
         "b_breedother"))
```


##### age vs prior
###### 1. distributional
```{r}
mcmc_plot(model,
          variable = c("b_sAge", "prior_b_sAge"))
```


###### 2. density
```{r}
mcmc_plot(model,
          variable = c("b_sAge", "prior_b_sAge"),
          type = "areas") +

   theme_classic() +
    labs(title = "Prior vs posterior distribution for age effect") +
         labs(y = "") +
         labs(x = paste0("Possible parameter values")) +
    scale_y_discrete(labels=c("prior_b_sAge" = "Prior", "b_sAge" = "Posterior"),
                     limits = c("prior_b_sAge", "b_sAge")) +
         theme(axis.title.y = element_text(size=12, face="bold"), 
               axis.title.x = element_text(size=12, face="bold"),
               title = element_text(size=12, face="bold"),
               plot.title = element_text(hjust = 0.5),
               axis.text.x = element_text(color = "grey50", size = 12),
               axis.text.y = element_text(color = "grey8",size = 12))
```








## b. all parameters except nu
```{r}
mcmc_plot(model, variable = c(
         "b_Intercept",
         "sigma",
         "b_sAge",
         "b_breedckcs",
         "b_breedpug",
         "b_breedret",
         "b_breedother"))
```


# 3. Plot all posterior distributions
```{r}
posterior <- as.matrix(model)
mcmc_areas(posterior,
pars = c("b_Intercept", "sigma",
         "b_sAge",
         "b_breedckcs",
         "b_breedpug",
         "b_breedret",
         "b_breedother"),
# arbitrary threshold for shading probability mass
prob = 0.75)
```


## 4. plot posterior distribution for for betas
```{r}
posterior <- as.matrix(model)
mcmc_areas(posterior,
    pars = c("b_sAge",
            "b_breedckcs",
            "b_breedpug",
            "b_breedret",
            "b_breedother"),
    prob = 0.75) # arbitrary threshold for shading probability mass
```



# Plot posterior distribution for age
```{r}
posterior <- as.matrix(model)
mcmc_areas(posterior,
pars = "b_sAge",
# arbitrary threshold for shading probability mass
prob = 0.97) +
  
   theme_classic() +
     labs(title = "Posterior distribution for age effect", 
         y = "Density distribution", 
         x = "Possible parameter values") +
    scale_y_discrete(labels=("b_sAge" = "")) +
         theme(axis.title.y = element_text(size=12, face="bold"), 
               axis.title.x = element_text(size=12, face="bold"),
               title = element_text(size=12, face="bold"),
               plot.title = element_text(hjust = 0.5),
               axis.text.x = element_text(color = "grey50", size = 12),
               axis.text.y = element_text(color = "grey8",size = 12))
```




## 5. Describe the posterior visually
```{r}
# Focus on describing posterior
hdi_range <- hdi(model, ci = c(0.65, 0.70, 0.80, 0.89, 0.95))
plot(hdi_range, show_intercept = T)
```



### just sAge
```{r}
# Focus on describing posterior
hdi_range <- hdi(model, ci = c(0.65, 0.70, 0.80, 0.89, 0.95), parameters = "sAge")
plot(hdi_range, show_intercept = T) +

    labs(title = "Posterior distribution for age effect") +
         labs(y = "Density distribution") +
         labs(x = "Possible parameter values") +
           theme(axis.title.y = element_text(size=12, face="bold"), 
               axis.title.x = element_text(size=12, face="bold"),
               title = element_text(size=12, face="bold"),
               plot.title = element_text(hjust = 0.5),
               axis.text.x = element_text(color = "grey50", size = 12),
               axis.text.y = element_text(color = "grey8",size = 12))
```




# 6. Posterior prediction for effect of sAge on Log cortisol (when visit = vO, breed = mix,)
```{r}
# determine the range of `a` values we'd like to feed into `fitted()`
nd <- tibble(sAge = seq(from = -3.2, to = 3.2, length.out = 30), visit = "v0", breed = "mix")

# now use `fitted()` to get the model-implied trajectories
fitted(model,
       newdata = nd) %>% 
  data.frame() %>% 
  bind_cols(nd) %>% 
  
  # plot
  ggplot(aes(x = sAge)) +
  geom_smooth(aes(y = Estimate, ymin = Q2.5, ymax = Q97.5),
              stat = "identity",
              fill = "#F8766D", color = "#F8766D", alpha = 1/5, linewidth = 1) +
  geom_point(data = df, 
             aes(y = slgCort), 
             size = 2, color = "#F8766D") +
  labs(x = "Age (standardised)",
       y = "Log hair cortisol (standardised)") +
  coord_cartesian(xlim = range(df$sAge), 
                  ylim = range(df$slgCort)) +
  theme_bw() +
  theme(panel.grid = element_blank()) 
```



# HYPOTHESIS TESTS

## 1. Hypothesis test to check if mean association between cortisol and body fat (from draws) is >0
```{r}
draws <- as.matrix(model)
mean(draws[,2] >0)
mean(draws[,2] <0)
```


## 2. Check 97% credible interval of with HPDI for body fat from draws 
```{r}
HPDI(draws[,2], prob=0.97)
```




## 3. Visualising the posterior of a model using numerical and graphical methods
### a. Basic (one dog only)
```{r}
# create new dataframe which contains results of the first dog
new_data <- rbind(df[1,], df[1,], df[1,], df[1,], df[1,])
# Now change one category to be different
new_data$sAge <- c(-2, -1, 0, 1, 2)
# Visualise df to make sure it has worked
new_data

# Now get mean predictions from the draws of the model
pred_means <- posterior_predict(model, newdata = new_data)

# Compare difference in means between the two categories (-2 vs 0)
difference <- pred_means[,1] - pred_means[,3]
# Visualise
head(difference)
# Examine mean of difference
mean(difference)
# View histogram of this
hist(difference)
# Create HPDI
HPDI(difference, 0.97)

# Compare difference in means between the two categories (-1 vs 0)
difference <- pred_means[,2] - pred_means[,3]
# Visualise
head(difference)
# Examine mean of difference
mean(difference)
# View histogram of this
hist(difference)
# Create HPDI
HPDI(difference, 0.97)

# Compare difference in means between the two categories (1 vs 0)
difference <- pred_means[,4] - pred_means[,3]
# Visualise
head(difference)
# Examine mean of difference
mean(difference)
# View histogram of this
hist(difference)
# Create HPDI
HPDI(difference, 0.97)

# Compare difference in means between the two categories (2 vs 0)
difference <- pred_means[,5] - pred_means[,3]
# Visualise
head(difference)
# Examine mean of difference
mean(difference)
# View histogram of this
hist(difference)
# Create HPDI
HPDI(difference, 0.97)
```


### b. Advanced (all dogs)
```{r}
# create new dataframe which contains results of all dogs
new_data1 <- df
# Now change one category to be different
new_data1$Age <- c(-1)

# create new dataframe which contains results of the first dog
new_data2 <- df
# Now change one category to be different
new_data2$sAge <- c(1)

# Now get predictions from the draws of the models
pred_nd1 <- posterior_predict(model, newdata = new_data1)
pred_nd2 <- posterior_predict(model, newdata = new_data2)
pred_diff <- pred_nd1 - pred_nd2
pred_diff <- data.frame(pred_diff)

# Create mean of differences for each column (dog) of the dataframe
pred_diff_mean <- apply(pred_diff, 2, mean)
# View histogram of mean differences
hist(pred_diff_mean)
# mean difference
mean(pred_diff_mean)
# Create HPDI
HPDI(pred_diff_mean, 0.97)
```


# 4. Make predictions of log cortisol for each dog and compare with actual data
```{r}
pred_slgCort <- posterior_epred(model)
av_pred_slgCort <- colMeans(pred_slgCort)
plot(av_pred_slgCort ~ df$slgCort)
```


## 1. Plot the predicted effect of age on log hair cortisol
```{r}
set.seed(666)
nd1 <- tibble(sAge = seq(-3, 3, by = 1), visit = 0,
              breed = "mix",
              case_number = c("dog1", "dog2", "dog3","dog4", "dog5", "dog6", "dog7"))

p1 <-
  predict(model,
          resp = "slgCort",
          allow_new_levels = TRUE,
          newdata = nd1) %>% 
  data.frame() %>% 
  bind_cols(nd1) %>% 
  
  ggplot(aes(x = sAge, y = Estimate, ymin = Q2.5, ymax = Q97.5)) +
  
  geom_linerange(aes(ymin = Estimate - Est.Error, ymax = Estimate + Est.Error),
                 linewidth = 1, color = "#F8766D", alpha = 3/5) +
  geom_point(size = 5, color = "#F8766D") +
  theme_bw() +
  labs(title = "Predicted effect of age on hair cortisol",
       x = "Age (standardised)",
       y = "Log hair cortisol (standardised)") +
  theme(axis.title.y = element_text(size=12, face="bold"), 
        axis.title.x = element_text(size=12, face="bold"),
        title = element_text(size=12, face="bold"),
        plot.title = element_text(hjust = 0.5)) +
  coord_cartesian(ylim = c(-2.5, 2.5)) +
  scale_x_continuous(breaks=seq(-3, 3 , 1))

plot(p1)
```


