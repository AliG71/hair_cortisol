---
title: "hair_cortisol_dog_combined_breed"
author: "Alex German"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Check working directory
```{r}
getwd()
```





# Load packages
```{r}
library(readxl)
library(psych)
library(dlookr)
library(vtable)
library(dplyr)
library(reshape)
library(ggplot2)

library(brms)
library(rethinking)
library(loo)
library(priorsense)
library(tidyverse)
library(vioplot)
library(bayesplot)
library(bayestestR)
```


# Load data
```{r}
df <- read_xlsx("hair_cort_dog_all.xlsx", col_types = c("text", "text",  
                               "text", "text", "text", "text",
                               "text", "numeric","text", "skip",
                               "numeric", "skip", "skip", 
                               "numeric", "skip"))
df <- as.data.frame(df)
```



# INITIAL DATA PLOTTING AND EXPLORATION

## Check characteristics of df
```{r}
dim(df) # will tell you how many rows and columns the dataset has
class(df) # will tell you what data structure has the dataset been assigned
```


## Explore the dataset to understand its structure.
```{r}
head(df)
```


# 1.  Get summary stats for numeric data ####
```{r}
numeric_df <- Filter(is.numeric, df)
describe(numeric_df) # the describe function in psych provides summary stats
```



# 2. Check normality of all numeric variables
## a. graphical assessment
```{r}
plot_normality(numeric_df)
```


## b. shapiro-wilk test
```{r}
apply(numeric_df, 2, shapiro.test)
```


## c. repeat Q-Q plots with transformed data
### i. log(cortisol)
```{r}
qqnorm(df$cortisol)
qqline(df$cortisol, col = "red")
qqnorm(log(df$cortisol))
qqline(log(df$cortisol), col = "red")
```

### ii Shapiro test for log cortisol
```{r}
shapiro.test(log(df$cortisol))
```






# 3. Check data numerically
```{r}
summary(df$cortisol)
summary(log(df$cortisol))
```


## a. Log-transform cortisol
```{r}
df$lgCort <- log(df$cortisol)
summary(df$lgCort)
```

### i. Visualise
```{r}
hist(df$lgCort)
```



## b. Create simple category name for breed and convert to factor
```{r}
df$breed <- df$breed_group
df$breed <- factor(df$breed, levels = c("mix", "ckcs", "pug", "ret", "other"))
head(df$breed)
```



# 4. Generate data summary
```{r}
sumtable(df)
```



# 5. Visualise associations
## a. Between Cortisol and sex with a violin plot (vioplot package)
```{r}
par(mfrow = c(1,1))
vioplot(cortisol ~ sex, col = "firebrick",
        data = df)
```


## b. Between log(cortisol) and sex with a violin plot (vioplot package)
```{r}
par(mfrow = c(1,1))
vioplot(lgCort ~ sex, col = "lemonchiffon",
        data = df)
```


## c. Between lgCortisol and breed...
### i. with a violin plot (vioplot package)
```{r}
par(mfrow = c(1,1))
vioplot(lgCort ~ breed, col = "firebrick",
        data = df)
```


### ii. with stropchart
```{r}
stripchart(lgCort ~ breed, vertical = TRUE, method = "jitter",
           col = "steelblue3", data = df, pch = 20)

```


# STANDARDISE DATA FOR MODELLING


## 1. Standardise cortisol
```{r}
df$slgCort <- standardize(df$lgC)
summary(df$slgCort)
```

### a. visualise standardised lgCort
```{r}
hist(df$slgCort)
```


## 2. create dataset only containing complete data
```{r}
df2 <- na.omit(df)
```




# MODEL FOR THE EFFECT OF SEX ON HAIR CORTISOL

##  1. Model code
model <- brm(slgCort ~ sex +  + (1 | visit),
                   family = skew_normal(),
                   data = df2)



## 2. Check what priors need to be set
```{r}
default_prior(slgCort ~ sex +  + (1 | visit),
                   family = skew_normal(),
                   data = df)
```

### Published information about associations with hair cortisol
In humans, males have > hair cortisol cf females (Binz TM.  ForensicSciInt 2018; 284:33–8. doi: 10.1016/j.forsciint.2017.12.032)
...but effect is opposite in vervet monlkys (Laudenslager ML.  Psychoneuroendocrinology 2012; 37:1736–9. doi: 10.1016/j.psyneuen.2012.03.015).
... no effect of sex in a previous dog study (Macbeth BJ.  Wildl Soc Bull 2012; 36:747–58. doi: 10.1002/wsb.219)
... however, this study did find that neutered dogs had decreased hair cortisol.
... as all dogs in the study were neutered, this means that an effect of sex is less likely.
Bowland et al, female dogs had > hair cortisol than male dogs, but all dogs were intact (Bowland JB.  Front. Vet. Sci 2020; 7:565346.  doi: 10.3389/fvets.2020.565346)
Further, this effect was lost when accounting for other effects.

Therefore, use a regularising prior but keep it neutral and broad, to allow the effect to be either way.

NB Bowland found no age effect.  They also found a negative effect of BCS on log hair cortisol (beta -0.03).  However, BCS ranged from 1-6 (with only 1 BCS 6), so few overweight.... could suggest poor nutrition and health cf obesity.  (Bowland JB.  Front. Vet. Sci 2020; 7:565346.  doi: 10.3389/fvets.2020.565346)


## 3. Set priors
```{r}
# Set individual priors
prior_int <- set_prior("normal(0, 0.5)", class = "Intercept")
prior_sig <- set_prior("exponential(1)", class = "sigma")
prior_b <- set_prior("normal(0, 1)", class = "b")
prior_sd <- set_prior("normal(0, 1)", class = "sd")
prior_alpha <- set_prior("normal(4, 2)", class = "alpha")

# Combine priors into list
priors <- c(prior_int, prior_sig, prior_b, prior_sd)
```


## 4. Plot priors
### a. Prior for intercept and beta
```{r}
x <- seq(-3, 3, length.out = 100)
y <- dnorm(x, mean = 0, sd = 0.5)
plot(y ~ x, type = "l")
```




### b. Prior for sigma
```{r}
x <- seq(0, 3, length.out = 100)
y <- dexp(x, rate = 1)
plot(y ~ x, type = "l")
```

### a. Prior for beta
```{r}
x <- seq(-3, 3, length.out = 100)
y <- dnorm(x, mean = 0, sd = 1)
plot(y ~ x, type = "l")
```



## 5.  RUN MODEL
Increased adapt_delta >0.8 (0.9 here), as had divergent transitions
```{r}
set.seed(666)
model <- brm(slgCort ~ sex + (1 | visit),
                   family = skew_normal(),
                   prior = priors,
                   data = df,
                   control=list(adapt_delta=0.9999, stepsize = 0.001, max_treedepth =15),
                   iter = 8000, warmup = 2000,
                   cores = 4,
                   save_pars = save_pars(all =TRUE),
                   sample_prior = TRUE)
```


## 6. Get summary of model
```{r}
summary(model)
```

## 7. MCMC diagnostics
```{r}
plot(model)
```
Looking for hairy caterpillars


## b. try a trank plot as well
```{r}
mcmc_plot(model, type = 'rank_overlay')
```



# 8. Calculate 97% HPDI for sex
Usually better than the compatoability intervals given in the summary
```{r}
draws <- as.matrix(model)
HPDI(draws[,2], 0.97) # 1st column is draws for sex
```


# 9. Calculate R2 for model
```{r}
bayes_R2(model, probs = c(0.015, 0.5, 0.985)) # 0.015, 0.5, 0.985 are the quantiles
loo_R2(model, probs = c(0.015, 0.5, 0.985)) # 0.015, 0.5, 0.985 are the quantiles
```



# CHECKS ON MODEL

## 1. Basic check of simulations based on posterior distribution, versus the real data distribution
checks whether actual data is similar to simulated data.
```{r}
pp_check(model, ndraws = 100) 
```



## 2. Check some individual draws versus observed using pp_check
```{r}
par(mfrow = c(1,1))
pp_check(model, type = "hist", ndraws = 11, binwidth = 0.25) # separate histograms of 11 MCMC draws vs actual data
```



## 3. Other pp_check graphs
```{r}
pp_check(model, type = "error_hist", ndraws = 11) # separate histograms of errors for 11 draws
pp_check(model, type = "scatter_avg", ndraws = 100) # scatter plot
pp_check(model, type = "stat_2d") #  scatterplot of joint posteriors
# PPC functions for predictive checks based on (approximate) leave-one-out (LOO) cross-validation
pp_check(model, type = "loo_pit_overlay", ndraws = 1000) 
```


## 4. Error scatter average  plot (recommended by Buerkner)
```{r}
pp_check(model, type = "error_scatter_avg")
```



## 5. Pairs plot
```{r}
pairs(model)
```



# PSIS LOO-CV to check model performance
```{r}
loo_model <- loo(model, moment_match = TRUE)
loo_model
```



# AUTOMATED PRIOR SENSITIVITY USING THE PRIOR SENSE PACKAGE

## 1. Sensitivity check
First, check the sensitivity of the prior and likelihood to power-scaling. 
Posterior and posteriors resulting from power-scaling.
```{r}
powerscale_sensitivity(model, variable = c("b_Intercept", "sigma", "b_sexMale"))
```

These values appear similar to what was set for the priors, so seems OK?



# 2.  Now use bayestestR package to check priors are informative
```{r}
check_prior(model, effects = "all")
```




# CHECK PRIOR PREDICTION LINES FROM FINAL MODEL

# 1. Obtain draws of priors from final model
```{r}
prior <- prior_draws(model)
prior %>% glimpse()
```




# 2. Plot prior prediction lines for sex with line plot
```{r}
set.seed(5)

prior %>% 
  slice_sample(n = 50) %>% 
  rownames_to_column("draw") %>% 
  expand_grid(a = c(0, 1)) %>% 
  mutate(c = Intercept + b * a) %>% 
  
  ggplot(aes(x = a, y = c)) +
  geom_line(aes(group = draw),
            color = "firebrick", alpha = .4) +
  geom_point(color = "firebrick", size = 2) +
  labs(x = "Sex (male)",
       y = "log(cort) (std)") +
  coord_cartesian(ylim = c(-3, 3)) +
  theme_bw() +
  theme(panel.grid = element_blank()) 
```







# CHECK PRIOR PREDICTIVE DISTRIBUTION

# 1. Prior Predictive Distribution
Can simulate data just on the priors.  Fit model but only consider prior when fitting model.
If this looks reasonable, it helps to confirm that your priors were reasonable
```{r}
set.seed(666)
model_priors_only <- brm(slgCort ~ sex + (1 | visit),
                   family = skew_normal(),
                   prior = priors,
                   data = df,
                   sample_prior = "only")
```


# 2. Check predictions against priors
```{r}
pp_check(model_priors_only, ndraws = 100)
```



# VARIANCE-COVARIANCE MATRIX
```{r}
as_draws_df(model) %>%
  select(b_Intercept:sigma) %>%
  cov() %>%
  round(digits = 3)
```





# MANUAL POSTERIOR PREDICTIVE DISTRIBUTION CHECKS
NB Uses posterior_predict

## 1. Posterior predictive distribition plots for sex
```{r}
# use posterior predict to simulate predictions
ppd <- posterior_predict(model) 
dim(ppd)

par(mfrow = c(2,2))
stripchart(slgCort ~ sex, vertical = TRUE, method = "jitter",
           col = "steelblue3", data = df, pch = 20, main = "Observed")
stripchart(ppd[sample(seq(1, dim(ppd)[1]), 1),] ~ sex, vertical = TRUE, method = "jitter",
           col = "firebrick", data = df, pch = 20, main = "PPD")
stripchart(ppd[sample(seq(1, dim(ppd)[1]), 1),] ~ sex, vertical = TRUE, method = "jitter",
           col = "firebrick", data = df, pch = 20, main = "PPD")
stripchart(ppd[sample(seq(1, dim(ppd)[1]), 1),] ~ sex, vertical = TRUE, method = "jitter",
           col = "firebrick", data = df, pch = 20, main = "PPD")
```






## ANALYSING THE POSTERIOR DISTRIBUTION


# 1. Plot conditional effects from model
```{r}
plot(conditional_effects(model), ask = FALSE)
```

### 1b. advanced plot of conditional effect of coat colour
```{r}
ce <- conditional_effects(model, effects = "sex")
ce_df <- ce[[1]][c(1, 6:9)]

ggplot(ce_df, aes(x=sex, y=estimate__, group=1)) +
    geom_errorbar(width=.1, aes(ymin=lower__, ymax=upper__), colour=c("#F8766D", "#00BFC4"), linewidth = 1) +
    geom_point(shape=21, size=6, fill=c("#F8766D", "#00BFC4")) +
   theme_bw() +
    labs(title = "Conditional effect of sex on hair cortisol") +
         labs(y = paste0("Log Hair Cortisol (standardised)")) +
         labs(x = paste0("Sex")) +
         theme(axis.title.y = element_text(size=12, face="bold"), 
               axis.title.x = element_text(size=12, face="bold"),
               title = element_text(size=12, face="bold"),
               plot.title = element_text(hjust = 0.5),
               axis.text.x = element_text(color = "grey25", size = 12),
               axis.text.y = element_text(color = "grey50", size = 10))
```




# 2. mcmc_plot of model
## a. all parameters except alpha and sd_visit_intercept
```{r}
mcmc_plot(model, variable = c(
         "b_Intercept",
         "sigma",
         "b_sexMale"))
```


## b. sex versus prior
### i. distributional
```{r}
mcmc_plot(model,
          variable = c("b_sexMale", "prior_b"))
```


###### 2. density
```{r}
mcmc_plot(model,
          variable = c("b_sexMale", "prior_b"),
          type = "areas") +

   theme_classic() +
    labs(title = "Prior vs posterior distribution for sex effect") +
         labs(y = "") +
         labs(x = paste0("Possible parameter values")) +
    scale_y_discrete(labels=c("prior_b" = "Prior for male", "b_sexMale" = "Posterior for male"),
                     limits = c("prior_b", "b_sexMale")) +
         theme(axis.title.y = element_text(size=12, face="bold"), 
               axis.title.x = element_text(size=12, face="bold"),
               title = element_text(size=12, face="bold"),
               plot.title = element_text(hjust = 0.5),
               axis.text.x = element_text(color = "grey50", size = 12),
               axis.text.y = element_text(color = "grey8",size = 12))

```





# 3. Plot all posterior distributions
```{r}
posterior <- as.matrix(model)
mcmc_areas(posterior,
pars = c("b_Intercept", "sigma",
         "b_sexMale"),
# arbitrary threshold for shading probability mass
prob = 0.75)
```


## 4. plot posterior distribution for sex only
```{r}
posterior <- as.matrix(model)
mcmc_areas(posterior,
    pars = c("b_sexMale"),
# arbitrary threshold for shading probability mass
prob = 0.97) +
  
   theme_classic() +
     labs(title = "Posterior distribution for sex effect", 
         y = "Density distribution", 
         x = "Possible parameter values") +
     scale_y_discrete(labels=c("b_sexMale" = "Posterior for male")) +
         theme(axis.title.y = element_text(size=12, face="bold"), 
               axis.title.x = element_text(size=12, face="bold"),
               title = element_text(size=12, face="bold"),
               plot.title = element_text(hjust = 0.5),
               axis.text.x = element_text(color = "grey50", size = 12),
               axis.text.y = element_text(color = "grey8",size = 12))
```



## 5. Describe the posterior visually
```{r}
# Focus on describing posterior
hdi_range <- hdi(model, ci = c(0.65, 0.70, 0.80, 0.89, 0.95))
plot(hdi_range, show_intercept = T)
```


### just coat colour
```{r}
# Focus on describing posterior
hdi_range <- hdi(model, ci = c(0.65, 0.70, 0.80, 0.89, 0.95),
                 parameters = "b_sexMale")
plot(hdi_range, show_intercept = T) +

    labs(title = "Posterior distribution for sex effect") +
         labs(y = "Density distribution") +
         labs(x = "Possible parameter values") +
           theme(axis.title.y = element_text(size=12, face="bold"), 
               axis.title.x = element_text(size=12, face="bold"),
               title = element_text(size=12, face="bold"),
               plot.title = element_text(hjust = 0.5),
               axis.text.x = element_text(color = "grey50", size = 12),
               axis.text.y = element_text(color = "grey8",size = 12))
```





# HYPOTHESIS TESTS

## 1. Hypothesis test to check if mean association between cortisol and sex (from draws) is >0
```{r}
draws <- as.matrix(model)
mean(draws[,2] >0)
mean(draws[,2] <0)
```


## 2. Check 97% credible interval of with HPDI for sex from draws 
```{r}
HPDI(draws[,2], prob=0.97)
```





## 3. Visualising the posterior of a model using numerical and graphical methods
### a. basic (one dog only)
```{r}
# create new dataframe which contains results of the first dog
new_data <- rbind(df[1,], df[1,])
# Now change one category to be different
new_data$sex <- c("Female", "Male")
# Visualise df to make sure it has worked
new_data

# Now get mean predictions from the draws of the model
pred_means <- posterior_predict(model, newdata = new_data)


# Compare difference in means for each breedversus mix
differenceMale <- pred_means[,1] - pred_means[,2]

par(mfrow = c(2,2))

# Examine mean of difference
mean(differenceMale)
# View histogram of this
hist(differenceMale)
# Create HPDI
HPDI(differenceMale, 0.97)

```



### b. Advanced... using all dogs in the model
#### i. male vs female
```{r}
# create new dataframe which contains results of all dogs
new_data1 <- df
# Now change one category to be different
new_data1$sex <- c("Male")

# create new dataframe which contains result sof all dogs
new_data2 <- df
# Now change one category to be different
new_data2$sex <- c("Female")

# Now get predictions from the draws of the models
pred_nd1 <- posterior_predict(model, newdata = new_data1)
pred_nd2 <- posterior_predict(model, newdata = new_data2)
pred_diff <- pred_nd1 - pred_nd2
pred_diff <- data.frame(pred_diff)

# Create mean of differences for each column (dog) of the dataframe
pred_diff_ckcs <- apply(pred_diff, 2, mean)
# View histogram of mean differences
hist(pred_diff_ckcs)

# Examine mean of difference
mean(pred_diff_ckcs)
# View histogram of this

HPDI(pred_diff_ckcs, 0.93)
```






# 5. Make predictions of log cortisol for each dog and compare with actual data
```{r}
pred_slgCort <- posterior_epred(model)
av_pred_slgCort <- colMeans(pred_slgCort)
plot(av_pred_slgCort ~ df$slgCort)
```










## 6. plot the counterfactual effect of "do sex" on slgCort
### a. plot estimates and 95% credible intervals 
```{r}
set.seed(666)
nd <- tibble(visit = 'v0', sex = c("Female", "Male"))

p1 <-
  predict(model,
          resp = "slgCort",
          newdata = nd) %>% 
  data.frame() %>% 
  bind_cols(nd) %>% 
  
  ggplot(aes(x = sex, y = Estimate, ymin = Q2.5, ymax = Q97.5)) +
  
  geom_linerange(aes(ymin = Q2.5, ymax = Q97.5),
                 linewidth = 1, color = "#F8766D", alpha = 3/5) +
  geom_point(size = 5, color = "#F8766D") +

   theme_bw() +
    labs(title = "Total counterfactual effect of sex on log hair cortisol") +
         labs(y = paste0("Counterfactual estimate of Log Hair Cortisol (std)")) +
         labs(x = paste0("Manipulated visit")) +
         theme(axis.title.y = element_text(size=12, face="bold"), 
               axis.title.x = element_text(size=12, face="bold"),
               title = element_text(size=12, face="bold"),
               plot.title = element_text(hjust = 0.5)) +
         coord_cartesian(ylim = c(-2.5, 2.5))

plot(p1)
```








# Check if better fit if you allow SD to vary across sex

## 1. Set priors
NB no sigma prior because this will be estimated in in the model
```{r}
# Set individual priors
prior_int <- set_prior("normal(0, 1)", class = "Intercept")
prior_b <- set_prior("normal(0, 1)", class = "b")
prior_sd <- set_prior("normal(0, 1)", class = "sd")
prior_alpha <- set_prior("normal(4, 2)", class = "alpha")

# Combine priors into list
priors2 <- c(prior_int, prior_b, prior_sd)
```





## 2. Run model 2
Increased adapt_delta >0.8 (0.9 here), as had divergent transitions
```{r}
set.seed(666)
model2 <- brm(bf(slgCort ~ sex + (1 | visit),
                 sigma ~ sex),
                   family = skew_normal(),
                   prior = priors2,
                   data = df,
                   control=list(adapt_delta=0.9999, stepsize = 0.001, max_treedepth =15),
                   iter = 8000, warmup = 2000,
                   cores = 4,
                   save_pars = save_pars(all =TRUE),
                   sample_prior = TRUE)
```


## 3. Get summary of model
```{r}
summary(model2)
```




# 4. Try the PSIS LOO-CV procedure to check model performance
```{r}
loo_model2 <- loo(model, moment_match = TRUE)
loo_model2
```


# 5. Compare looic for models 1 and 2
```{r}
model <- add_criterion(model, "loo")
model2 <- add_criterion(model2, "loo")
loo_compare(model, model2)
```
Very little difference between models, so probably better to use simplest model.

